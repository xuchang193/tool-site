{% extends 'base.html' %}

{% block content %}
<style>
    /* ä¸»å¸ƒå±€ï¼šå·¦å³ä¸¤æ  */
    .journal-page {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* å·¦ä¾§ï¼šå†™æ—¥è®°åŒºåŸŸ */
    .journal-write {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .journal-header {
        text-align: center;
        margin-bottom: 25px;
    }

    .journal-header h1 {
        color: #333;
        margin-bottom: 8px;
        font-size: 28px;
    }

    .timer-section {
        text-align: center;
        margin-bottom: 25px;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .timer-display {
        font-size: 42px;
        font-weight: bold;
        margin: 8px 0;
        font-family: 'Courier New', monospace;
    }

    .timer-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .timer-warning {
        color: #ffeb3b;
    }

    .timer-danger {
        color: #ff5252;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .question-section {
        margin-bottom: 20px;
    }

    .question-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .question-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 70px;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
    }

    .question-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .submit-section {
        margin-top: 25px;
        text-align: center;
    }

    .submit-btn {
        padding: 12px 35px;
        font-size: 15px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .status-message {
        margin-top: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        display: none;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-message.show {
        display: block;
    }

    .time-up-message {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #ffc107;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: 600;
    }

    /* å³ä¾§ï¼šå›é¡¾åŒºåŸŸ */
    .journal-review {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .review-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .review-header h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 5px;
    }

    /* æ—¥æœŸå¯¼èˆª */
    .date-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    .nav-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #e0e0e0;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #666;
        transition: all 0.2s ease;
    }

    .nav-btn:hover {
        border-color: #667eea;
        color: #667eea;
        background: #f5f7ff;
    }

    .date-display {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        min-width: 130px;
        text-align: center;
    }

    /* æ—¥æœŸé€‰æ‹©å™¨ */
    .date-picker-section {
        margin-bottom: 20px;
        text-align: center;
    }

    .date-picker-input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: border-color 0.2s ease;
    }

    .date-picker-input:focus {
        outline: none;
        border-color: #667eea;
    }

    /* æ—¥è®°å†…å®¹å±•ç¤º */
    .review-content {
        margin-top: 20px;
    }

    .review-item {
        margin-bottom: 18px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .review-item-title {
        font-size: 14px;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
    }

    .review-item-content {
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .review-item-content.none {
        color: #999;
        font-style: italic;
    }

    .review-status {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 14px;
    }

    /* å¯¼å‡ºæŒ‰é’®åŒºåŸŸ */
    .export-section {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
    }

    .export-section h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .export-btn {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        color: white;
        background: #28a745;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .export-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }

    .export-btn.month {
        background: #17a2b8;
    }

    .export-btn.month:hover {
        background: #138496;
    }

    .export-btn.custom {
        background: #6c757d;
    }

    .export-btn.custom:hover {
        background: #5a6268;
    }

    .custom-export {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        justify-content: center;
    }

    .custom-export input {
        width: 70px;
        padding: 8px 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
    }

    .custom-export input:focus {
        outline: none;
        border-color: #667eea;
    }

    .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .nav-btn:disabled:hover {
        border-color: #e0e0e0;
        color: #666;
        background: #fff;
    }

    /* å“åº”å¼ */
    @media (max-width: 1000px) {
        .journal-page {
            grid-template-columns: 1fr;
        }

        .journal-review {
            position: static;
        }
    }
</style>

<div class="journal-page">
    <!-- å·¦ä¾§ï¼šå†™æ—¥è®° -->
    <div class="journal-write">
        <div class="journal-header">
            <h1>ğŸŒ… æ™¨é—´æ—¥è®°</h1>
            <p style="color: #666; font-size: 14px;">é™æ—¶ 3 åˆ†é’Ÿï¼Œè®°å½•ä»Šå¤©çš„ç¾å¥½å¼€å§‹</p>
        </div>

        <div class="timer-section">
            <div class="timer-label">å‰©ä½™æ—¶é—´</div>
            <div class="timer-display" id="timerDisplay">03:00</div>
            <div class="timer-label" id="timerLabel">è¯·å¼€å§‹è®°å½•</div>
        </div>

        <div class="time-up-message" id="timeUpMessage" style="display: none;">
            â° æ—¶é—´åˆ°ï¼è¯·å°½å¿«æäº¤ä½ çš„æ—¥è®°
        </div>

        <form id="journalForm">
            <div class="question-section">
                <div class="question-title">âœ… æ˜¨å¤©æˆåŠŸåšäº†ä»€ä¹ˆï¼Ÿ</div>
                <textarea class="question-input" id="success" name="success" placeholder="å†™ä¸‹æ˜¨å¤©è®©ä½ æ„Ÿåˆ°éª„å‚²æˆ–æ»¡æ„çš„äº‹æƒ…..."
                    required></textarea>
            </div>

            <div class="question-section">
                <div class="question-title">ğŸ˜” æ˜¨å¤©çš„é—æ†¾æ˜¯ä»€ä¹ˆï¼Ÿ</div>
                <textarea class="question-input" id="regret" name="regret" placeholder="è®°å½•æ˜¨å¤©çš„ä¸è¶³æˆ–é—æ†¾ï¼Œå¸®åŠ©ä»Šå¤©æ”¹è¿›..."
                    required></textarea>
            </div>

            <div class="question-section">
                <div class="question-title">â­ æœ¬æ—¥ç²¾åï¼ˆä¸€ä»¶äº‹ï¼‰</div>
                <textarea class="question-input" id="highlight" name="highlight" placeholder="ä»Šå¤©æœ€é‡è¦çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ..."
                    required></textarea>
            </div>

            <div class="question-section">
                <div class="question-title">ğŸ¸ ä»Šå¤©è¦å…ˆåƒçš„é’è›™ï¼Ÿ <span style="color: #667eea;">Eat First!</span></div>
                <textarea class="question-input" id="frog" name="frog" placeholder="å†™ä¸‹ä»Šå¤©æœ€é‡è¦ã€æœ€éœ€è¦ä¼˜å…ˆå®Œæˆçš„ä»»åŠ¡..."
                    required></textarea>
            </div>

            <div class="submit-section">
                <button type="submit" class="submit-btn" id="submitBtn">æäº¤æ—¥è®°</button>
                <div class="status-message" id="statusMessage"></div>
            </div>
        </form>
    </div>

    <!-- å³ä¾§ï¼šå›é¡¾æ—¥è®° -->
    <div class="journal-review">
        <div class="review-header">
            <h2>ğŸ“– å›é¡¾æ—¥è®°</h2>
        </div>

        <!-- æ—¥æœŸå¯¼èˆª -->
        <div class="date-nav">
            <button class="nav-btn" id="prevDay" title="å‰ä¸€å¤©">â—€</button>
            <div class="date-display" id="reviewDate">2025-01-01</div>
            <button class="nav-btn" id="nextDay" title="åä¸€å¤©">â–¶</button>
        </div>

        <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
        <div class="date-picker-section">
            <input type="date" class="date-picker-input" id="datePicker">
        </div>

        <!-- æ—¥è®°å†…å®¹ -->
        <div class="review-content" id="reviewContent">
            <div class="review-item">
                <div class="review-item-title">âœ… æ˜¨å¤©æˆåŠŸåšäº†ä»€ä¹ˆï¼Ÿ</div>
                <div class="review-item-content" id="review-success">åŠ è½½ä¸­...</div>
            </div>
            <div class="review-item">
                <div class="review-item-title">ğŸ˜” æ˜¨å¤©çš„é—æ†¾æ˜¯ä»€ä¹ˆï¼Ÿ</div>
                <div class="review-item-content" id="review-regret">åŠ è½½ä¸­...</div>
            </div>
            <div class="review-item">
                <div class="review-item-title">â­ æœ¬æ—¥ç²¾åï¼ˆä¸€ä»¶äº‹ï¼‰</div>
                <div class="review-item-content" id="review-highlight">åŠ è½½ä¸­...</div>
            </div>
            <div class="review-item">
                <div class="review-item-title">ğŸ¸ ä»Šå¤©è¦å…ˆåƒçš„é’è›™ï¼Ÿ</div>
                <div class="review-item-content" id="review-frog">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å¯¼å‡ºåŠŸèƒ½ -->
        <div class="export-section">
            <h3>ğŸ“¥ å¯¼å‡ºæ—¥è®°</h3>
            <div class="export-buttons">
                <a href="/morning-journal/export?period=7" class="export-btn" target="_blank">è¿‡å» 7 å¤©</a>
                <a href="/morning-journal/export?period=30" class="export-btn month" target="_blank">è¿‡å» 30 å¤©</a>
            </div>
            <div class="custom-export">
                <input type="number" id="customDays" min="1" max="365" value="14" placeholder="å¤©æ•°">
                <button class="export-btn custom" id="customExportBtn">è‡ªå®šä¹‰å¯¼å‡º</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ========== å€’è®¡æ—¶é€»è¾‘ ==========
    let timeLeft = 180;
    let timerInterval = null;
    let isTimeUp = false;
    let isSubmitted = false;

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimer() {
        const timerDisplay = document.getElementById('timerDisplay');
        const timerLabel = document.getElementById('timerLabel');

        // ç¡®ä¿æ—¶é—´ä¸ä¸ºè´Ÿæ•°
        if (timeLeft < 0) {
            timeLeft = 0;
        }

        timerDisplay.textContent = formatTime(timeLeft);

        if (timeLeft > 120) {
            timerDisplay.className = 'timer-display';
            timerLabel.textContent = 'æ—¶é—´å……è¶³ï¼Œæ…¢æ…¢æ€è€ƒ';
        } else if (timeLeft > 60) {
            timerDisplay.className = 'timer-display';
            timerLabel.textContent = 'æ—¶é—´è¿˜å¤Ÿï¼Œç»§ç»­æ€è€ƒ';
        } else if (timeLeft > 30) {
            timerDisplay.className = 'timer-display timer-warning';
            timerLabel.textContent = 'æ—¶é—´è¿‡åŠï¼ŒåŠ å¿«èŠ‚å¥';
        } else if (timeLeft > 0) {
            timerDisplay.className = 'timer-display timer-danger';
            timerLabel.textContent = 'æ—¶é—´ä¸å¤šï¼Œå°½å¿«å®Œæˆ';
        } else {
            timerDisplay.className = 'timer-display timer-danger';
            timerLabel.textContent = 'æ—¶é—´åˆ°ï¼';
            timeUp();
        }
    }

    function timeUp() {
        isTimeUp = true;
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById('timeUpMessage').style.display = 'block';
    }

    function startTimer() {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
            if (!isTimeUp && !isSubmitted) {
                if (timeLeft > 5) {
                    timeLeft -= 5; // æ¯5ç§’å‡å°‘5ç§’
                } else {
                    timeLeft = 0; // å¦‚æœä¸è¶³5ç§’ï¼Œç›´æ¥å½’é›¶
                }
                updateTimer();
            }
        }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
    }

    // ========== å›é¡¾åŠŸèƒ½ ==========
    // é»˜è®¤æ˜¾ç¤ºæ˜¨å¤©çš„æ—¥è®°
    let currentReviewDate = new Date();
    currentReviewDate.setDate(currentReviewDate.getDate() - 1);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    function formatDateStr(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function updateDateDisplay() {
        document.getElementById('reviewDate').textContent = formatDateStr(currentReviewDate);
        document.getElementById('datePicker').value = formatDateStr(currentReviewDate);

        // æ›´æ–°"åä¸€å¤©"æŒ‰é’®çŠ¶æ€
        const nextBtn = document.getElementById('nextDay');
        const currentDateOnly = new Date(currentReviewDate);
        currentDateOnly.setHours(0, 0, 0, 0);

        if (currentDateOnly >= today) {
            nextBtn.disabled = true;
        } else {
            nextBtn.disabled = false;
        }
    }

    async function loadJournal(dateStr) {
        // è·å–å„ä¸ªå†…å®¹å…ƒç´ ï¼Œé¿å…é‡æ–°æ¸²æŸ“æ•´ä¸ªåŒºåŸŸ
        const successEl = document.getElementById('review-success');
        const regretEl = document.getElementById('review-regret');
        const highlightEl = document.getElementById('review-highlight');
        const frogEl = document.getElementById('review-frog');

        try {
            const response = await fetch(`/morning-journal/get?date=${dateStr}`);
            const result = await response.json();

            if (result.status === 'success') {
                const data = result.data;

                // æ›´æ–°å„ä¸ªå­—æ®µå†…å®¹
                successEl.textContent = data.success;
                successEl.className = 'review-item-content' + (data.success === 'None' ? ' none' : '');

                regretEl.textContent = data.regret;
                regretEl.className = 'review-item-content' + (data.regret === 'None' ? ' none' : '');

                highlightEl.textContent = data.highlight;
                highlightEl.className = 'review-item-content' + (data.highlight === 'None' ? ' none' : '');

                frogEl.textContent = data.frog;
                frogEl.className = 'review-item-content' + (data.frog === 'None' ? ' none' : '');
            } else {
                successEl.textContent = 'åŠ è½½å¤±è´¥';
                regretEl.textContent = 'åŠ è½½å¤±è´¥';
                highlightEl.textContent = 'åŠ è½½å¤±è´¥';
                frogEl.textContent = 'åŠ è½½å¤±è´¥';
            }
        } catch (error) {
            successEl.textContent = 'åŠ è½½å¤±è´¥ï¼š' + error.message;
            regretEl.textContent = '-';
            highlightEl.textContent = '-';
            frogEl.textContent = '-';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function goToPrevDay() {
        currentReviewDate.setDate(currentReviewDate.getDate() - 1);
        updateDateDisplay();
        loadJournal(formatDateStr(currentReviewDate));
    }

    function goToNextDay() {
        const nextDate = new Date(currentReviewDate);
        nextDate.setDate(nextDate.getDate() + 1);
        nextDate.setHours(0, 0, 0, 0);

        // ä¸èƒ½è¶…è¿‡ä»Šå¤©
        if (nextDate > today) {
            return;
        }

        currentReviewDate.setDate(currentReviewDate.getDate() + 1);
        updateDateDisplay();
        loadJournal(formatDateStr(currentReviewDate));
    }

    // ========== è¡¨å•æäº¤ ==========
    function showMessage(message, type) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type} show`;

        if (type === 'success') {
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 5000);
        }
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ–è®¡æ—¶å™¨
        updateTimer();

        // ç›‘å¬è¾“å…¥æ¡†å¼€å§‹è®¡æ—¶
        const inputs = document.querySelectorAll('.question-input');
        inputs.forEach(input => {
            input.addEventListener('focus', startTimer, { once: true });
            input.addEventListener('input', startTimer, { once: true });
        });

        // åˆå§‹åŒ–å›é¡¾åŠŸèƒ½
        updateDateDisplay();
        loadJournal(formatDateStr(currentReviewDate));

        // æ—¥æœŸå¯¼èˆªæŒ‰é’®
        document.getElementById('prevDay').addEventListener('click', goToPrevDay);
        document.getElementById('nextDay').addEventListener('click', goToNextDay);

        // æ—¥æœŸé€‰æ‹©å™¨ - è®¾ç½®æœ€å¤§æ—¥æœŸä¸ºä»Šå¤©
        const datePicker = document.getElementById('datePicker');
        datePicker.max = formatDateStr(today);

        datePicker.addEventListener('change', function () {
            const selectedDate = this.value;
            if (selectedDate) {
                const selected = new Date(selectedDate + 'T00:00:00');
                // ä¸èƒ½è¶…è¿‡ä»Šå¤©
                if (selected > today) {
                    this.value = formatDateStr(today);
                    currentReviewDate = new Date(today);
                } else {
                    currentReviewDate = selected;
                }
                updateDateDisplay();
                loadJournal(formatDateStr(currentReviewDate));
            }
        });

        // è¡¨å•æäº¤
        document.getElementById('journalForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (isSubmitted) {
                showMessage('ä½ å·²ç»æäº¤è¿‡äº†ï¼', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            const formData = {
                success: document.getElementById('success').value.trim(),
                regret: document.getElementById('regret').value.trim(),
                highlight: document.getElementById('highlight').value.trim(),
                frog: document.getElementById('frog').value.trim()
            };

            if (!formData.success || !formData.regret || !formData.highlight || !formData.frog) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰é—®é¢˜ï¼', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤æ—¥è®°';
                return;
            }

            try {
                const response = await fetch('/morning-journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    isSubmitted = true;
                    if (timerInterval) clearInterval(timerInterval);
                    showMessage('âœ… ' + result.message, 'success');
                    submitBtn.textContent = 'å·²æäº¤';

                    document.querySelectorAll('.question-input').forEach(input => {
                        input.disabled = true;
                    });

                    // åˆ·æ–°ä»Šå¤©çš„å›é¡¾
                    const today = formatDateStr(new Date());
                    if (formatDateStr(currentReviewDate) === today) {
                        loadJournal(today);
                    }
                } else {
                    showMessage('âŒ ' + result.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æäº¤æ—¥è®°';
                }
            } catch (error) {
                showMessage('âŒ æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤æ—¥è®°';
            }
        });

        // è‡ªå®šä¹‰å¯¼å‡º
        document.getElementById('customExportBtn').addEventListener('click', function () {
            const days = document.getElementById('customDays').value;
            if (days && days >= 1 && days <= 365) {
                window.open(`/morning-journal/export?period=${days}`, '_blank');
            } else {
                alert('è¯·è¾“å…¥ 1-365 ä¹‹é—´çš„å¤©æ•°');
            }
        });
    });
</script>
{% endblock %}